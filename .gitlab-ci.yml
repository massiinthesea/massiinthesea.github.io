services:
    - docker:dind

stages:
    - install
    - test
    - build
    # - publish

install:
    stage: install
    image: node:11-alpine
    script:
        - npm install
    only:
        - master
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules

test:
    image: markhobson/node-chrome:latest
    stage: test
    script:
        - npm link @angular/cli@11.0.0
        - npm test -- --browsers=ChromeHeadless --watch=false
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules
            
build:
    image: node:11-alpine
    stage: build
    script:
        - npm link @angular/cli@11.0.0
        - npm run build
    artifacts:
        paths:
            - $CI_PROJECT_DIR/dist
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules

# push-docker-registry:
#   image: docker:latest
#   stage: publish
#   only:
#     - master
#   script:
#     - docker build -t registry.gitlab.com/chikaslocalhost/angular-ci-cd .
#     - docker login -u chikaslocalhost -p $CI_BUILD_TOKEN registry.gitlab.com
#     - docker push registry.gitlab.com/chikaslocalhost/angular-ci-cd
